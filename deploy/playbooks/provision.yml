---
- hosts: rails
  become: yes

  vars_files:
    - vars.yml

  roles:
    - geerlingguy.git
    - geerlingguy.nodejs
    - geerlingguy.ruby
    - geerlingguy.passenger
    - geerlingguy.postgresql

  pre_tasks:
    - name: Update apt cache if needed.
      apt: update_cache=yes cache_valid_time=3600

  tasks:
    - name: Install app dependencies.
      apt: "name={{ item }} state=present"
      with_items:
        - libreadline-dev

    - name: Ensure app directory exists and is writeable.
      file:
        path: "{{ app_directory }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: 0755

    - name: Install Rails {{rails_version}}
      gem: 
        name: rails
        version: "{{rails_version}}"
        state: present
        become: yes
        become_user: "{{ app_user }}"
